<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<style>
html * {
	font-family: sans-serif;
	font-size: 16px;
}

.axis {
	font-family: sans-serif;
	font-size: 15px;
}

.axis--x path {
	display: none;
}

.line {
	fill: none;
	stroke: steelblue;
	stroke-width: 1.5px;
}

fieldset {
	display: inline;
	vertical-align: top;
	height: 330px;
}
</style>
</head>

<body>
  <svg width="1900" height="900"></svg>
  <form id="requestForm">
    <fieldset>
      <legend>Benchmark</legend>
      <input type="radio" name="benchmark" value="terasort-flink-10G-10" checked>
      TeraSort Flink 10G (cumu02-[05-14])
      <br />
      <input type="radio" name="benchmark" value="terasort-hadoop-100G-10">
      TeraSort Hadoop 100G (cumu02-[05-14])
      <br />
      <br />
      <br />
      <hr>
      <input type="radio" name="benchmark" value="peakpicking-10G-10">
      Peakpicking 10G (cumu02-[05-14])
      <br />
    </fieldset>
    <fieldset>
      <legend>Left Y Axis</legend>
      <input type="radio" name="yLeft" value="" checked>
      None
      <br />
      <input type="radio" name="yLeft" value="jvm.read.count,jvm.write.count,sfs.read.count,sfs.write.count@count">
      JVM Reads, JVM Writes, SFS Reads, SFS Writes
      <br />
      <input type="radio" name="yLeft" value="jvm.read.duration,jvm.write.duration,sfs.read.duration,sfs.write.duration@time(s)">
      JVM Read Time, JVM Write Time, SFS Read Time, SFS Write Time (seconds)
      <br />
      <input type="radio" name="yLeft" value="jvm.read.data,jvm.write.data,sfs.read.data,sfs.write.data@data(mb)">
      JVM Read Data, JVM Write Data, SFS Read Data, SFS Write Data (megabytes)
      <br />
      <hr>
      <input type="radio" name="yLeft" value="sfs.read.remoteCount@count">
      SFS Remote Reads
      <br />
      <input type="radio" name="yLeft" value="sfs.read.remoteDuration@time(s)">
      SFS Remote Read Time (seconds)
      <br />
      <input type="radio" name="yLeft" value="sfs.read.remoteData@data(mb)">
      SFS Remote Read Data (megabytes)
      <br />
    </fieldset>
    <fieldset>
      <legend>Right Y Axis</legend>
      <input type="radio" name="yRight" value="" checked>
      None
      <br />
      <input type="radio" name="yRight" value="jvm.read.cum.duration,jvm.write.cum.duration,sfs.read.cum.duration,sfs.write.cum.duration@time(s)">
      Cum. JVM Read Time, Cum. JVM Write Time, Cum. SFS Read Time, Cum. SFS Write Time (seconds)
      <br />
      <input type="radio" name="yRight" value="jvm.read.cum.data,jvm.write.cum.data,sfs.read.cum.data,sfs.write.cum.data@data(gb)">
      Cum. JVM Read Data, Cum. JVM Write Data, Cum. SFS Read Data, Cum. SFS Write Data (gigabytes)
      <br />
      <input type="radio" name="yRight" value="jvm.read.speed,jvm.write.speed,sfs.read.speed,sfs.write.speed@mb/s">
      JVM Read Speed, JVM Write Speed, SFS Read Speed, SFS Write Speed (megabytes/second)
      <br />
      <hr>
      <input type="radio" name="yRight" value="sfs.read.cum.remoteDuration@data(gb)">
      Cum. SFS Remote Read Time (gigabytes)
      <br />
      <input type="radio" name="yRight" value="sfs.read.cum.remoteData@data(gb)">
      Cum. SFS Remote Read Data (gigabytes)
      <br />
      <input type="radio" name="yRight" value="sfs.read.remoteSpeed@speed(mb/s)">
      SFS Remote Read Speed (megabytes/second)
      <br />
    </fieldset>
    <fieldset>
      <legend>Hosts</legend>
      <input type="checkbox" name="hosts" value="cumu01-00">
      cumu01-00
      <input type="checkbox" name="hosts" value="cumu02-00">
      cumu02-00
      <br />
      <input type="checkbox" name="hosts" value="cumu01-01">
      cumu01-01
      <input type="checkbox" name="hosts" value="cumu02-01">
      cumu02-01
      <br />
      <input type="checkbox" name="hosts" value="cumu01-02">
      cumu01-02
      <input type="checkbox" name="hosts" value="cumu02-02">
      cumu02-02
      <br />
      <input type="checkbox" name="hosts" value="cumu01-03">
      cumu01-03
      <input type="checkbox" name="hosts" value="cumu02-03">
      cumu02-03
      <br />
      <input type="checkbox" name="hosts" value="cumu01-04">
      cumu01-04
      <input type="checkbox" name="hosts" value="cumu02-04">
      cumu02-04
      <br />
      <input type="checkbox" name="hosts" value="cumu01-05">
      cumu01-05
      <input type="checkbox" name="hosts" value="cumu02-05">
      cumu02-05
      <br />
      <input type="checkbox" name="hosts" value="cumu01-06">
      cumu01-06
      <input type="checkbox" name="hosts" value="cumu02-06">
      cumu02-06
      <br />
      <input type="checkbox" name="hosts" value="cumu01-07">
      cumu01-07
      <input type="checkbox" name="hosts" value="cumu02-07">
      cumu02-07
      <br />
      <input type="checkbox" name="hosts" value="cumu01-08">
      cumu01-08
      <input type="checkbox" name="hosts" value="cumu02-08">
      cumu02-08
      <br />
      <input type="checkbox" name="hosts" value="cumu01-09">
      cumu01-09
      <input type="checkbox" name="hosts" value="cumu02-09">
      cumu02-09
      <br />
      <input type="checkbox" name="hosts" value="cumu01-10">
      cumu01-10
      <input type="checkbox" name="hosts" value="cumu02-10">
      cumu02-10
      <br />
      <input type="checkbox" name="hosts" value="cumu01-11">
      cumu01-11
      <input type="checkbox" name="hosts" value="cumu02-11">
      cumu02-11
      <br />
      <input type="checkbox" name="hosts" value="cumu01-12">
      cumu01-12
      <input type="checkbox" name="hosts" value="cumu02-12">
      cumu02-12
      <br />
      <input type="checkbox" name="hosts" value="cumu01-13">
      cumu01-13
      <input type="checkbox" name="hosts" value="cumu02-13">
      cumu02-13
      <br />
      <input type="checkbox" name="hosts" value="cumu01-14">
      cumu01-14
      <input type="checkbox" name="hosts" value="cumu02-14">
      cumu02-14
      <br />
      <input type="checkbox" name="hosts" value="cumu01-15">
      cumu01-15
      <input type="checkbox" name="hosts" value="cumu02-15">
      cumu02-15
      <br />
    </fieldset>

    <button type="button" onclick="setHosts(true)">All Hosts</button>
    <button type="button" onclick="setHosts(false)">No Hosts</button>
    <button type="button" onclick="toggleHosts()">Toggle Hosts</button>
    <button type="button" onclick="updateGraph()">Submit</button>
  </form>

  <script src="//d3js.org/d3.v4.min.js"></script>
  <script>
    var sources = [ "jvm", "sfs" ];
    var categories = [ "read", "write", "other" ];
  
    function setHosts(checked) {
      var hosts = document.getElementsByName("hosts");
      for (i = 0; i < hosts.length; ++i) {
        hosts[i].checked = checked;
      }
    }
    
    function toggleHosts() {
      var hosts = document.getElementsByName("hosts");
      for (i = 0; i < hosts.length; ++i) {
        hosts[i].checked = !hosts[i].checked;
      }
    }
    
    var svg = d3.select("svg");
    var margin = {
      top : 20,
      right : 100,
      bottom : 100,
      left : 100
    };
    var width = svg.attr("width") - margin.left - margin.right;
    var height = svg.attr("height") - margin.top - margin.bottom;

    var x = d3.scaleTime().range([ 0, width ]);
    var yLeft = d3.scaleLinear().range([ height, 0 ]);
    var yRight = d3.scaleLinear().range([ height, 0 ]);
    var z = d3.scaleOrdinal(d3.schemeCategory10);
    
    var lines = {};
    var yLeftLineNames = [
      "jvm.read.count", "jvm.write.count", "sfs.read.count", "sfs.write.count",
      "jvm.read.duration", "jvm.write.duration", "sfs.read.duration", "sfs.write.duration",
      "jvm.read.data", "jvm.write.data", "sfs.read.data", "sfs.write.data",
      "sfs.read.remoteCount", "sfs.read.remoteDuration", "sfs.read.remoteData"
    ];
    var yRightLineNames = [
      "jvm.read.cum.data", "jvm.write.cum.data", "sfs.read.cum.data", "sfs.write.cum.data",
      "jvm.read.cum.duration", "jvm.write.cum.duration", "sfs.read.cum.duration", "sfs.write.cum.duration",
      "jvm.read.speed", "jvm.write.speed", "sfs.read.speed", "sfs.write.speed",
      "sfs.read.cum.remoteDuration", "sfs.read.cum.remoteData", "sfs.read.remoteSpeed"
    ];

    for (i = 0; i < yLeftLineNames.length; ++i) {
      lines[yLeftLineNames[i]] = function(i) {
        return d3.line()
          .x(function(d) { return x(d.time); })
          .y(function(d) { return yLeft(+Object.resolve(yLeftLineNames[i], d) || 0); });
      }(i);
    }

    for (i = 0; i < yRightLineNames.length; ++i) {
      lines[yRightLineNames[i]] = function(i) {
        return d3.line()
          .x(function(d) { return x(d.time); })
          .y(function(d) { return yRight(+Object.resolve(yRightLineNames[i], d) || 0); });
      }(i);
    }
        
    function updateGraph() {
      svg.selectAll("*").remove();
      var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      
      var form = document.getElementById("requestForm").elements;
      
      var requestedBenchmark = form["benchmark"].value;
      
      var requestedYLeftLineNames = [];
      var requestedYLeftAxis = "";
      if (form["yLeft"].value != "") {
        var axis = form["yLeft"].value.split("@");
        requestedYLeftLineNames = axis[0].split(",");
        requestedYLeftAxis = axis[1];
      }
      
      var requestedYRightLineNames = [];
      var requestedYRightAxis = "";
      if (form["yRight"].value != "") {
        var axis = form["yRight"].value.split("@");
        requestedYRightLineNames = axis[0].split(",");
        requestedYRightAxis = axis[1];
      }
      
      var requestedHosts = [];
      for (i = 0; i < form["hosts"].length; ++i) {
        if (form["hosts"][i].checked) {
          requestedHosts.push(form["hosts"][i].value);
        }
      }
      
      var loadedDataCount = 0;
      var allDataLoaded = function(allData) {
        loadedDataCount += 1;
        if (loadedDataCount < requestedHosts.length * sources.length * categories.length) {
          return;
        }
        
        // augment data with computed properties
        var cum = {
          jvm : { read : {}, write : {}, other : {} },
          sfs : { read : {}, write : {}, other : {} }
        };

        for (i = 0; i < allData.length; ++i) {
          cum.jvm.read.duration = (cum.jvm.read.duration || 0) + (allData[i].jvm.read.duration || 0);
          cum.jvm.read.data = (cum.jvm.read.data || 0) + (allData[i].jvm.read.data || 0) / 1024;
          cum.sfs.read.duration = (cum.sfs.read.duration || 0) + (allData[i].sfs.read.duration || 0);
          cum.sfs.read.data = (cum.sfs.read.data || 0) + (allData[i].sfs.read.data || 0) / 1024;
          cum.sfs.read.remoteDuration = (cum.sfs.read.remoteDuration || 0) + (allData[i].sfs.read.remoteDuration || 0);
          cum.sfs.read.remoteData = (cum.sfs.read.remoteData || 0) + (allData[i].sfs.read.remoteData || 0) / 1024;
          
          cum.jvm.write.duration = (cum.jvm.write.duration || 0) + (allData[i].jvm.write.duration || 0);
          cum.jvm.write.data = (cum.jvm.write.data || 0) + (allData[i].jvm.write.data || 0) / 1024;
          cum.sfs.write.duration = (cum.sfs.write.duration || 0) + (allData[i].sfs.write.duration || 0);
          cum.sfs.write.data = (cum.sfs.write.data || 0) + (allData[i].sfs.write.data || 0) / 1024;
          
          cum.jvm.other.duration = (cum.jvm.other.duration || 0) + (allData[i].jvm.other.duration || 0);
          cum.sfs.other.duration = (cum.sfs.other.duration || 0) + (allData[i].sfs.other.duration || 0);
          
          allData[i].jvm.read.cum = {};
          allData[i].jvm.read.cum.duration = cum.jvm.read.duration;
          allData[i].jvm.read.cum.data = cum.jvm.read.data;
          
          allData[i].sfs.read.cum = {};
          allData[i].sfs.read.cum.duration = cum.sfs.read.duration;
          allData[i].sfs.read.cum.data = cum.sfs.read.data;
          allData[i].sfs.read.cum.remoteDuration = cum.sfs.read.remoteDuration;
          allData[i].sfs.read.cum.remoteData = cum.sfs.read.remoteData;
          
          allData[i].jvm.write.cum = {};
          allData[i].jvm.write.cum.duration = cum.jvm.write.duration;
          allData[i].jvm.write.cum.data = cum.jvm.write.data;
          
          allData[i].sfs.write.cum = {};
          allData[i].sfs.write.cum.duration = cum.sfs.write.duration;
          allData[i].sfs.write.cum.data = cum.sfs.write.data;
          
          allData[i].jvm.other.cum = {};
          allData[i].jvm.other.cum.duration = cum.jvm.other.duration;
          
          allData[i].sfs.other.cum = {};
          allData[i].sfs.other.cum.duration = cum.sfs.other.duration;
        }
        
        x.domain(d3.extent(allData, function(d) {
          return d.time;
        }));
        
        yLeft.domain([0, d3.max(allData, function(d) {
          var max = Number.MIN_VALUE;
          for (i = 0; i < requestedYLeftLineNames.length; ++i) {
            max = Math.max(max, +Object.resolve(requestedYLeftLineNames[i], d) || 0);
          }
          return max;
        })]);
        
        yRight.domain([0, d3.max(allData, function(d) {
          var max = Number.MIN_VALUE;
          for (i = 0; i < requestedYRightLineNames.length; ++i) {
            max = Math.max(max, +Object.resolve(requestedYRightLineNames[i], d) || 0);
          }
          return max;
        })]);
        
        z.domain(requestedYLeftLineNames.concat(requestedYRightLineNames).map(function(d) {
          return d.hashCode();
        }));
        
        g.append("g")
          .attr("class", "axis axis--x")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%H:%M:%S")))
          .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-45)");
  
        g.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(yLeft))
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .style("font", "15px sans-serif")
            .attr("fill", "#000")
            .text(requestedYLeftAxis);
            
        g.append("g")
          .attr("transform", "translate(" + width + ",0)")
          .attr("class", "axis axis--y")
          .call(d3.axisRight(yRight))
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .style("font", "15px sans-serif")
            .attr("fill", "#000")
            .text(requestedYRightAxis);
                  
        var allRequestedYLineNames = requestedYLeftLineNames.concat(requestedYRightLineNames);
        var plot = g.selectAll(".plot")
          .data(allRequestedYLineNames)
          .enter().append("g").attr("class", "plot");
        plot.append("path").attr("class", "line")
          .attr("d", function(d) { return lines[d](allData); })
          .style("stroke", function(d) { return z(d.hashCode()); });
        plot.append("text")
          .attr("transform", function(d) { return "translate(" + (width - 200) + "," + (20 * allRequestedYLineNames.indexOf(d)) + ")"; })
          .attr("x", 3)
          .attr("dy", "0.35em")
          .style("font", "15px sans-serif")
          .style("stroke", function(d) { return z(d.hashCode()); })
          .text(function(d) { return d; });
      }
      
      var timeBinMillis = 1000;
      
      var allData = [];
      for (i = 0; i < requestedHosts.length; ++i) {
        for (is = 0; is < sources.length; ++is) {
          for (ic = 0; ic < categories.length; ++ic) {
            // check whether the file exists, skip it if not
            var url = requestedBenchmark + "-logs/" + requestedHosts[i] + "." + sources[is] + "." + categories[ic] + ".csv";
            var urlHttp = new XMLHttpRequest();
            urlHttp.open("HEAD", url, false);
            urlHttp.send();
            if (urlHttp.status != 200) {
              console.log("File at URL:", url, " is not reachable, skipping.");

              // report we have loaded the data anyway
              allDataLoaded(allData);
              continue;
            }

            d3.csv(url, type, function(error, data) {
              if (error) {
                throw error;
              }
              
              for (j = 0; j < data.length; ++j) {
                var d = convert(data[j], timeBinMillis);
                var k = 0;
                for (; k < allData.length; ++k) {
                  if (allData[k].time > d.time) {
                    allData.splice(k, 0, d);
                    break;
                  } else if (allData[k].time == d.time) {
                    var s = d.source;
                    var c = d.category;
                    
                    // merge
                    allData[k][s][c].count = (allData[k][s][c].count || 0) + (d[s][c].count || 0);
                    allData[k][s][c].duration = (allData[k][s][c].duration || 0) + (d[s][c].duration || 0);
                    
                    allData[k][s][c].data = (allData[k][s][c].data || 0) + (d[s][c].data || 0);
                    
                    allData[k][s][c].remoteCount = (allData[k][s][c].remoteCount || 0) + (d[s][c].remoteCount || 0);
                    allData[k][s][c].remoteDuration = (allData[k][s][c].remoteDuration || 0) + (d[s][c].remoteDuration || 0);
                    allData[k][s][c].remoteData = (allData[k][s][c].remoteData || 0) + (d[s][c].remoteData || 0);
                    
                    allData[k][s][c].speed = (allData[k][s][c].speed || 0) + (d[s][c].speed || 0);
                    allData[k][s][c].remoteSpeed = (allData[k][s][c].remoteSpeed || 0) + (d[s][c].remoteSpeed || 0);
                    break;
                  }
                }
                if (k == allData.length) {
                  allData.push(d);
                }
              }
              
              allDataLoaded(allData);
            });
          }
        }
      }
    }
    
    String.prototype.hashCode = function(){
      var hash = 0;
      if (this.length == 0) return hash;
      for (i = 0; i < this.length; i++) {
        char = this.charCodeAt(i);
        hash = ((hash<<5)-hash)+char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return hash;
    }
    
    Object.resolve = function(path, obj) {
      return path.split('.').reduce(function(prev, curr) {
          return prev ? prev[curr] : undefined
      }, obj || self);
    }

    function type(d, _, columns) {
      // convert all but the first three columns to numerical values
      // first three are: hostname, source, category
      for (i = 3; i < columns.length; ++i) {
        d[columns[i]] = +d[columns[i]];
      }
      return d;
    }
    
    function convert(d, timeBinMillis) {
      var result = {
        jvm : { read : {}, write : {}, other : {} },
        sfs : { read : {}, write : {}, other : {} }
      };
      
      result.source = d.source;
      result.category = d.category;
      
      var s = d.source;
      var c = d.category;
      
      result.time =  d.startTime - d.startTime % timeBinMillis;
      result[s][c].count = d.count;
      result[s][c].duration = d.duration / 1000;
      
      // only for JVM/SFS READ/WRITE
      result[s][c].data = (d.data || 0) / 1048576;
      
      // only for SFS READ
      result[s][c].remoteCount = d.remoteCount || 0;
      result[s][c].remoteDuration = (d.remoteDuration || 0) / 1000;
      result[s][c].remoteData = (d.remoteData || 0) / 1048576;
      
      // compute some properties
      result[s][c].speed = result[s][c].duration > 0 ? result[s][c].data / result[s][c].duration : 0;
      result[s][c].remoteSpeed = result[s][c].duration > 0 ? result[s][c].remoteData / result[s][c].duration : 0;
      
      // console.log(result);

      return result;
    }
  </script>
</body>
</html>